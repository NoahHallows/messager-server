import socket
import pyodbc
import threading
import bcrypt

HOST = "0.0.0.0"
PORT = 23456
#PORT = 28752
clients = {}
clients_lock = threading.Lock()

SERVER = 'tcp:quackmsg.database.windows.net,1433'
DATABASE = 'messagedb'
USERNAME = 'noah'
PASSWORD = '9aie7Hgslc*9Wp'
connectionString = f'DRIVER={{ODBC Driver 18 for SQL Server}};SERVER={SERVER};DATABASE={DATABASE};UID={USERNAME};PWD={PASSWORD}'

try:
    db = pyodbc.connect(connectionString)
    cursor = db.cursor()
    print("Connection successful!")
except Exception as e:
    print("Error connecting to SQL Server.")
    print(e)

#logins = {"Noah": {'password': "$2b$12$Dhd2UJY4dktY4gfQ.3cQG.L1gxBPdbvcCatTibDimYLDq2HkId5ni", 'salt':"$2b$12$Dhd2UJY4dktY4gfQ.3cQG."}, "dad": {'password': "$2b$12$gFMcOWz0uGijshZNO5TZvewUIOJ8HahWG63bJmLqW7kDk.PNDMbGK", 'salt':"$2b$12$gFMcOWz0uGijshZNO5TZve"}}

def on_new_client(conn, addr):
     with conn:
        print(f"Connected by {addr}")
        # Recive inital instuction (create user or login)
        data = conn.recv(1024).decode().strip()
        if data == 'newaccount':
            username = create_user(conn, addr)
        else:
            username = login(conn, addr)
        print("FIGsaf")
        # Add to clients list
        with clients_lock:
            clients[username] = (conn, addr)
        # Recive messages and send to all clients
        client_run(conn, addr, username)
        # Cleanup on disconnect
        with clients_lock:
            del clients[username]
        print(f"Removed client {username} ({addr}) from clients list.")

def login(conn, addr):
     while True:
        username_sent = conn.recv(1024).decode().strip()
        SQL_STATEMENT = "SELECT 1 FROM USERS WHERE username = ?;"
        cursor.execute(SQL_STATEMENT, username_sent)
        row = cursor.fetchone()
        print(f"row == {row}")
        if row:
            print(f"Username {username_sent} found")
            username = username_sent
            SQL_STATEMENT = "SELECT password_hashed FROM USERS WHERE username = ?;"
            cursor.execute(SQL_STATEMENT, username)
            row = cursor.fetchone()
            salt = row[0]
            salt = salt.encode()
            print(f"salt is == {salt}")
            conn.sendall(salt)
            password_to_check = conn.recv(1042).decode().strip()
            SQL_STATEMENT = "SELECT password_hashed FROM USERS WHERE Username = ?;"
            cursor.execute(SQL_STATEMENT, username)
            row = cursor.fetchone()
            hashed_password = row[0]
            print(f"Hashed passwd from db is {hashed_password}")
            if bcrypt.checkpw(password_to_check.encode(), hashed_password.encode()):
                conn.sendall(b'1')
                print("Passwords matched")
                return username
            else:
                conn.sendall(b'0')
                print("Passwords do not match")
                continue
        if username_sent == "\0":
            exit()
        else:
            conn.sendall(str(False).encode())
            continue

def create_user(conn, addr):
    print("Creating account")
    while True:
        username_sent = conn.recv(1024).decode().strip()
        print(f"Username is: {username_sent}")
        SQL_STATEMENT = "SELECT 1 FROM USERS WHERE username = ?;"
        username_exist = cursor.execute(SQL_STATEMENT, username_sent)
        if username_exist != 1:
            print("Username not found")
            conn.sendall(b'0')
            password_hashed = conn.recv(1024).strip()
            salt = conn.recv(62).strip()
            print(f"Password is {password_hashed}, and salt is {salt}")
            SQL_STATEMENT = "INSERT INTO USERS (username, pa`ssword_hashed, salt) VALUES (?, ?, ?)"
            cursor.execute(SQL_STATEMENT, username_sent, password_hashed, salt)
            db.commit()
            conn.sendall(b'1')
            print("Finished")
            return username_sent
        else:
            print("Username was found")
            continue




def client_run(conn, addr, username):
    while True:
        data = conn.recv(1024)
        if not data:
            print(f"Client '{username}' at {addr} disconnected.")
            break
        message = data.decode().strip()
        print(f"Data from {username}: {message}")
        broadcast_message = f"{username}: {message}"
        for target_username, (target_conn, _) in clients.copy().items():
            if target_conn != conn:
                try:
                    target_conn.sendall(broadcast_message.encode())
                except:
                    print(f"Failed to send message to {target_username}")
 


def main():
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.bind((HOST, PORT))
    while True:
        s.listen()
        try:
            print("trying to connect")
            conn, addr = s.accept()
            thread = threading.Thread(target=on_new_client, args=(conn,addr, ))
            thread.start()
        except:
            print("Connection failed")
            s.close()
        if input() == ":q":
            cursor.close()
            conn.close()
            s.close()
            exit()
if __name__ == "__main__":   
    main()
